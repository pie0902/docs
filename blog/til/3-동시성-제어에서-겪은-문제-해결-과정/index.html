<!doctype html>
<html lang="ko" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">3.동시성 제어에서 겪은 문제 해결 과정 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pie0902.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pie0902.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정"><meta data-rh="true" property="og:locale" content="ko"><meta data-rh="true" name="docusaurus_locale" content="ko"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ko"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="3.동시성 제어에서 겪은 문제 해결 과정 | My Site"><meta data-rh="true" name="description" content="GitHub 링크"><meta data-rh="true" property="og:description" content="GitHub 링크"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-04-09T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/pie0902"><meta data-rh="true" property="article:tag" content="TIL,Database,HTTPS,Java,JWT,Network,Redis,Spring,Testing"><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정"><link data-rh="true" rel="alternate" href="https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정" hreflang="ko"><link data-rh="true" rel="alternate" href="https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정","mainEntityOfPage":"https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정","url":"https://pie0902.github.io/docs/blog/til/3-동시성-제어에서-겪은-문제-해결-과정","headline":"3.동시성 제어에서 겪은 문제 해결 과정","name":"3.동시성 제어에서 겪은 문제 해결 과정","description":"GitHub 링크","datePublished":"2024-04-09T00:00:00.000Z","author":{"@type":"Person","name":"thunder","description":"개발자","url":"https://github.com/pie0902"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://pie0902.github.io/docs/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/docs/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/docs/assets/css/styles.45b1dd04.css">
<script src="/docs/assets/js/runtime~main.9c1f109d.js" defer="defer"></script>
<script src="/docs/assets/js/main.6e6f4451.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs/img/logo.svg"><div role="region" aria-label="본문으로 건너뛰기"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">본문으로 건너뛰기</a></div><nav aria-label="메인" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="사이드바 펼치거나 접기" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/blog/categories">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Categories</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/blog/tags/til">TIL</a></li><li><a class="dropdown__link" href="/docs/blog/tags/dev">Dev</a></li><li><a class="dropdown__link" href="/docs/blog/tags/dev/java-springboot">Java/SpringBoot</a></li><li><a class="dropdown__link" href="/docs/blog/tags/cs">CS</a></li><li><a class="dropdown__link" href="/docs/blog/tags/project">Project</a></li><li><a class="dropdown__link" href="/docs/blog/tags/infra">Infra</a></li><li><a class="dropdown__link" href="/docs/blog/tags/embedded">Embedded</a></li><li><a class="dropdown__link" href="/docs/blog/tags/writing">Writing</a></li></ul></div></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/pie0902" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="어두운 모드와 밝은 모드 전환하기 (현재 system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_xvU1 postTitle_nF1Z">3.동시성 제어에서 겪은 문제 해결 과정</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-04-09T00:00:00.000Z">2024년 4월 9일</time> · <!-- -->약 5분</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/thunder"><span class="authorName_yefp" translate="no">thunder</span></a></div><small class="authorTitle_nd0D" title="개발자">개발자</small><div class="authorSocials_rSDt"><a href="https://github.com/pie0902" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p><a href="https://github.com/pie0902/TIL/blob/main/Spring/SpringBootPractices/redis-lock/2.%EB%8F%99%EC%8B%9C%EC%84%B1%20%EC%A0%9C%EC%96%B4%EC%97%90%EC%84%9C%20%EA%B2%AA%EC%9D%80%20%EB%AC%B8%EC%A0%9C%20%ED%95%B4%EA%B2%B0%20%EA%B3%BC%EC%A0%95.md" target="_blank" rel="noopener noreferrer" class="">GitHub 링크</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="개요">개요<a href="#개요" class="hash-link" aria-label="개요에 대한 직접 링크" title="개요에 대한 직접 링크" translate="no">​</a></h2>
<blockquote>
<p>진행하고 있는 팀 프로젝트에서 레디스(Redis)를 사용하여 동시성 제어를 적용했다.<br>
<!-- -->배포 환경에서의 동작 여부를 확인하기 위해 JMeter를 사용하여 테스트를 진행했다.<br>
<!-- -->그 과정에서 레디스 관련 심각한 이슈를 만났지만, 다행히도 문제를 해결할 수 있었다.<br>
<!-- -->이번 경험을 통해 레디스를 활용한 동시성 제어 구현에 대해 많은 것을 배울 수 있었다.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="코드">코드<a href="#코드" class="hash-link" aria-label="코드에 대한 직접 링크" title="코드에 대한 직접 링크" translate="no">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    //상품 주문 코드</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void createOrder(Map&lt;Long, Long&gt; basket, UserDetailsImpl userDetails, Long addressId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //상품 수량 검증 코드</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        checkBasket(basket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //주문 객체 생성</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Order order = new Order(userDetails.getUser().getId(), OrderState.NOTPAYED, addressId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //주문 객체 저장</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderRepository.save(order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //장바구니를 순회하며</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //주문한 상품과 상품 개수를 상품 상세정보 테이블에 업데이트</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //상품 테이블의 상품 수량 업데이트</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Long key : basket.keySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //레디슨 클라이언트를 사용한 분산 락 적용</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String lockKey = &quot;product_lock:&quot; + key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RLock lock = redissonClient.getLock(lockKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean isLocked = lock.tryLock(5, 10, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!isLocked) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(&quot;락 획득에 실패했습니다.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //상태를 업데이트하는 메서드</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                updateStockAndCreateOrderDetail(key, basket.get(key), order, basket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new RuntimeException(&quot;락 획득 중 오류가 발생했습니다.&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (lock.isLocked()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //상태를 업데이트하는 메서드</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void updateStockAndCreateOrderDetail(Long productId, Long quantity, Order order, Map&lt;Long, Long&gt; basket) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //영속성 컨텍스트를 초기화</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        entityManager.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //상품 객체 생성</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Product product = productService.getProduct(productId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        product.updateStockAfterOrder(quantity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //수정된 상품 저장</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        productService.save(product);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //상품 상세정보 객체 저장</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OrderDetail orderDetail = new OrderDetail(order, productId, quantity,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            product.getPrice(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            product.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDetailRepository.save(orderDetail);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="테스트-코드">테스트 코드<a href="#테스트-코드" class="hash-link" aria-label="테스트 코드에 대한 직접 링크" title="테스트 코드에 대한 직접 링크" translate="no">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@TestPropertySource(locations = &quot;classpath:test.properties&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OrderServiceTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@MockBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private ProductRepository productRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private OrderService orderService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserDetailsImpl userDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User user;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Product product;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Map&lt;Long, Long&gt; basket = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @BeforeEach</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //public void createOrder(Map&lt;Long, Long&gt; basket, UserDetailsImpl userDetails, Long addressId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user = new User(1L, &quot;tester&quot;, &quot;test@test.com&quot;, UserRoleEnum.USER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userDetails = new UserDetailsImpl(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    product = new Product(1L,&quot;test&quot;,1000L,&quot;test&quot;,1000L,&quot;photo&quot;,user.getId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    productRepository.save(product);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address = new Address(1L, &quot;test&quot;, &quot;test&quot;, &quot;test&quot;, user.getId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    basket.put(1L,2L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mockito.when(productRepository.findById(1L)).thenReturn(Optional.of(product));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // productRepository.getReferenceById가 호출될 때 product 객체를 반환하도록 설정</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mockito.when(productRepository.getReferenceById(1L)).thenReturn(product);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @DisplayName(&quot;병렬로 100번 실행하여 재고 업데이트 테스트&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void test(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IntStream.range(0, 100).parallel().forEach(i -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                orderService.createOrder(basket,userDetails,address.getId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="동시성-제어를-구현하다가-겪은-문제">동시성 제어를 구현하다가 겪은 문제<a href="#동시성-제어를-구현하다가-겪은-문제" class="hash-link" aria-label="동시성 제어를 구현하다가 겪은 문제에 대한 직접 링크" title="동시성 제어를 구현하다가 겪은 문제에 대한 직접 링크" translate="no">​</a></h2>
<ul>
<li class="">
<p>팀원분이 작성한 코드를 기반으로 레디슨 클라이언트를 사용해서 분산 락을 구현했다.</p>
</li>
<li class="">
<p>병렬로 실행한 테스트 코드가 정상 동작 했다.<br>
<!-- -->(수량 2개씩 100번 주문)</p>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="테스트-코드-실행-결과">테스트 코드 실행 결과<a href="#테스트-코드-실행-결과" class="hash-link" aria-label="테스트 코드 실행 결과에 대한 직접 링크" title="테스트 코드 실행 결과에 대한 직접 링크" translate="no">​</a></h4>
<p><a href="https://private-user-images.githubusercontent.com/47919911/319501213-587ca33c-4480-4b22-ab33-fa19e4ba4a68.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDEyMTMtNTg3Y2EzM2MtNDQ4MC00YjIyLWFiMzMtZmExOWU0YmE0YTY4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTA0NDIzMTk3MmE2NzlkNDgzY2UyOWQ0ZmI4ZTEyMTc3MzJkZGNhZTM1ZTY2NTZiMzJiMGQ3NzQ2NGNlODg1Y2QmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.rk5l0PULEGIhBAggM34pMNb3RepSB5tc6ze_a3UeOvo" target="_blank" rel="noopener noreferrer" class=""><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319501213-587ca33c-4480-4b22-ab33-fa19e4ba4a68.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDEyMTMtNTg3Y2EzM2MtNDQ4MC00YjIyLWFiMzMtZmExOWU0YmE0YTY4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTA0NDIzMTk3MmE2NzlkNDgzY2UyOWQ0ZmI4ZTEyMTc3MzJkZGNhZTM1ZTY2NTZiMzJiMGQ3NzQ2NGNlODg1Y2QmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.rk5l0PULEGIhBAggM34pMNb3RepSB5tc6ze_a3UeOvo" alt="테스트코드1" class="img_ev3q"></a></p>
<p><a href="https://private-user-images.githubusercontent.com/47919911/319501227-817b192b-3678-4201-b5fa-eaf4d12189b5.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDEyMjctODE3YjE5MmItMzY3OC00MjAxLWI1ZmEtZWFmNGQxMjE4OWI1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTllZDA5MDNjODg3NWJkMmE2Njg1MDQ4MDFjMDk2NDg5Mzc3YWM3MGMwNTU0M2FjMzA1MGFlZDNkMjNkNGQwYjAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.wb8S5iuWm6ZtocAxfMILlp0OBbi1ExRzEiIqRw4klMU" target="_blank" rel="noopener noreferrer" class=""><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319501227-817b192b-3678-4201-b5fa-eaf4d12189b5.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDEyMjctODE3YjE5MmItMzY3OC00MjAxLWI1ZmEtZWFmNGQxMjE4OWI1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTllZDA5MDNjODg3NWJkMmE2Njg1MDQ4MDFjMDk2NDg5Mzc3YWM3MGMwNTU0M2FjMzA1MGFlZDNkMjNkNGQwYjAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.wb8S5iuWm6ZtocAxfMILlp0OBbi1ExRzEiIqRw4klMU" alt="테스트코드2" class="img_ev3q"></a></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="jmeter를-사용한-테스트">JMeter를 사용한 테스트<a href="#jmeter를-사용한-테스트" class="hash-link" aria-label="JMeter를 사용한 테스트에 대한 직접 링크" title="JMeter를 사용한 테스트에 대한 직접 링크" translate="no">​</a></h4>
<ul>
<li class="">배포를 해야하기 때문에 확실한 검증이 필요해서 JMeter로 테스트를 해봤는데 결과가 이상했다.</li>
</ul>
<blockquote>
<p>JMeter 설정<br>
<!-- -->Number of Threads (users) : 100 으로 설정<br>
<!-- -->100명의 유저 csv 파일을 업로드<br>
<!-- -->1초에 100명의 유저가 동시에 1번 주문을 실행되도록 설정<br>
<!-- -->상품 개수는 1000개로 설정<br>
<!-- -->인증/인가 문제는 HTTP Cookie Manager와 Regular Expression Extractor 설정</p>
</blockquote>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="jmeterr-테스트-결과">JMeterr 테스트 결과<a href="#jmeterr-테스트-결과" class="hash-link" aria-label="JMeterr 테스트 결과에 대한 직접 링크" title="JMeterr 테스트 결과에 대한 직접 링크" translate="no">​</a></h4>
<ul>
<li class="">
<p>예상대로라면 상품은 1000개에서 900개로 수량이 줄어야 한다.</p>
<p><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319501236-da9b430c-e217-403f-866a-d2ce46b4ab9f.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDEyMzYtZGE5YjQzMGMtZTIxNy00MDNmLTg2NmEtZDJjZTQ2YjRhYjlmLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY5NTdlNWQ4YThlMzI2Mjk0MzdlYTZhMzc2YmZkYmUwMWI2MGQwYjYyMzkyZmNlYzA0MDdkZGM2NWUyZGI3ODQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.y6zw4qFpOM5Fq8zW4wBQktJD4fvcE6YIZRb4-4-fUys" alt="잘못된 테스트 결과" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319500969-e180f466-f41c-4558-8914-df5b89a6ae60.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDA5NjktZTE4MGY0NjYtZjQxYy00NTU4LTg5MTQtZGY1Yjg5YTZhZTYwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTk3NWNmODE4MjRlYTI4OTA1MDc5NzVlYjI1Mzc5Njg2ZGFmYTQyMTc2Y2Q2YzkwZTI4YjE3MjhlMjJhYzZlZmUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.E2jtfAvg4XubKZl1CK3aP_dlXYUHXcqRDa4w1UD-vyg" alt="잘못된 테스트 수량" class="img_ev3q"></p>
</li>
<li class="">
<p>하지만 숫자가 올라갔다 내려갔다 이상한 값이 출력 되었다.</p>
</li>
<li class="">
<p>수량이 900이 되어야하는데 982개로 되었다.</p>
</li>
<li class="">
<p>동시성이 제어가 안됐다.</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="해결-과정">해결 과정<a href="#해결-과정" class="hash-link" aria-label="해결 과정에 대한 직접 링크" title="해결 과정에 대한 직접 링크" translate="no">​</a></h2>
<ol>
<li class="">
<p>처음에는 코드를 잘못 작성한게 아닌가 해서 코드를 수정하면서 테스트를 진행해봤다.<strong>(실패)</strong></p>
</li>
<li class="">
<p>분산 락 적용 시 락 획득 대기 시간과 락 유지 시간을 조절하여 경쟁 상태를 피할 수 있을 거라 생각했다. 하지만 단순히 시간을 조절하는 것으로는 근본적인 해결이 되지 않았고, 오히려 불필요한 지연만 발생시켰다.<strong>(실패)</strong></p>
</li>
<li class="">
<p>@Transactional의 isolation 레벨을 높여 동시성 문제를 해결하려 했다. 하지만 isolation 레벨을 높이면 동시성 문제는 어느 정도 해결되지만, 동시에 성능 저하와 데드락 가능성이 높아지는 단점이 있다고 해서 관련 정보를 찾으며 코드를 작성하다가 중단했다.<strong>(실패)</strong></p>
</li>
</ol>
<p>4. 새벽 6시가 됐다 <strong>(수면실패)</strong></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="해결책">해결책<a href="#해결책" class="hash-link" aria-label="해결책에 대한 직접 링크" title="해결책에 대한 직접 링크" translate="no">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private final EntityManager entityManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//영속성 컨텍스트를 초기화</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">entityManager.clear();</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="해결된-테스트-결과">해결된 테스트 결과<a href="#해결된-테스트-결과" class="hash-link" aria-label="해결된 테스트 결과에 대한 직접 링크" title="해결된 테스트 결과에 대한 직접 링크" translate="no">​</a></h2>
<p><a href="https://private-user-images.githubusercontent.com/47919911/319501745-55f14396-9874-4444-a463-9a86d41f27e5.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDE3NDUtNTVmMTQzOTYtOTg3NC00NDQ0LWE0NjMtOWE4NmQ0MWYyN2U1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJiYzJlZjEyMGRlYjVjYzIxOWNmNDRiNjZjNTQxN2U3NWFlMTMyZmE1ODU3NmFmNzA4M2I4MmZmZWM2MzkzOTImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.yFsBEmhZcuEwuw2qPJvHvBgKuWmDHYhEonNcZNCecDQ" target="_blank" rel="noopener noreferrer" class=""><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319501745-55f14396-9874-4444-a463-9a86d41f27e5.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDE3NDUtNTVmMTQzOTYtOTg3NC00NDQ0LWE0NjMtOWE4NmQ0MWYyN2U1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJiYzJlZjEyMGRlYjVjYzIxOWNmNDRiNjZjNTQxN2U3NWFlMTMyZmE1ODU3NmFmNzA4M2I4MmZmZWM2MzkzOTImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.yFsBEmhZcuEwuw2qPJvHvBgKuWmDHYhEonNcZNCecDQ" alt="1" class="img_ev3q"></a></p>
<p><a href="https://private-user-images.githubusercontent.com/47919911/319501755-f3fb6e0c-1006-468f-af04-4a06f62cf8e5.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDE3NTUtZjNmYjZlMGMtMTAwNi00NjhmLWFmMDQtNGEwNmY2MmNmOGU1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTE4YzAxYzFiNTIxYjM0ODU3NjRiYTk4Y2JkOTEwMWRkMzBlMWUyNDQwYzAyZjM0MDVmMzAxM2RkZTc1MzE1YTMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.wrcUUFb6ZiRsyMcyt8zfn5oZ-i_2jR9KqKs12vOf9ek" target="_blank" rel="noopener noreferrer" class=""><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319501755-f3fb6e0c-1006-468f-af04-4a06f62cf8e5.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDE3NTUtZjNmYjZlMGMtMTAwNi00NjhmLWFmMDQtNGEwNmY2MmNmOGU1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTE4YzAxYzFiNTIxYjM0ODU3NjRiYTk4Y2JkOTEwMWRkMzBlMWUyNDQwYzAyZjM0MDVmMzAxM2RkZTc1MzE1YTMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.wrcUUFb6ZiRsyMcyt8zfn5oZ-i_2jR9KqKs12vOf9ek" alt="2" class="img_ev3q"></a></p>
<p><a href="https://private-user-images.githubusercontent.com/47919911/319501760-e7fc655c-d0c8-426b-96ea-eeceb1b9ff33.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDE3NjAtZTdmYzY1NWMtZDBjOC00MjZiLTk2ZWEtZWVjZWIxYjlmZjMzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTg5MzkyMjg0YmE2ZmQ3YjA2NzI5MzBjZGNlY2QxZTRjOGQwOGU0MjY1OTBjZDM4OTQxYmJiNzAzZDU0OTBiZWEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.0WX2lqdtyXtDwoAgOaxF3A5gcOZvyJVyoJnQyQsoYeE" target="_blank" rel="noopener noreferrer" class=""><img decoding="async" loading="lazy" src="https://private-user-images.githubusercontent.com/47919911/319501760-e7fc655c-d0c8-426b-96ea-eeceb1b9ff33.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTQzNjAyNDUsIm5iZiI6MTcxNDM1OTk0NSwicGF0aCI6Ii80NzkxOTkxMS8zMTk1MDE3NjAtZTdmYzY1NWMtZDBjOC00MjZiLTk2ZWEtZWVjZWIxYjlmZjMzLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MjklMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDI5VDAzMDU0NVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTg5MzkyMjg0YmE2ZmQ3YjA2NzI5MzBjZGNlY2QxZTRjOGQwOGU0MjY1OTBjZDM4OTQxYmJiNzAzZDU0OTBiZWEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.0WX2lqdtyXtDwoAgOaxF3A5gcOZvyJVyoJnQyQsoYeE" alt="수량" class="img_ev3q"></a></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="잘못된-결과가-나오는-이유">잘못된 결과가 나오는 이유<a href="#잘못된-결과가-나오는-이유" class="hash-link" aria-label="잘못된 결과가 나오는 이유에 대한 직접 링크" title="잘못된 결과가 나오는 이유에 대한 직접 링크" translate="no">​</a></h4>
<ul>
<li class="">
<p>영속성 컨텍스트에 저장된 오래된 데이터가 동시성 이슈를 일으킴</p>
</li>
<li class="">
<p><code>clear()</code>는 저장된 데이터를 초기화하고 DB에서 새 데이터를 가져옴</p>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="clear의-동시성-문제-해결-방법"><code>clear()</code>의 동시성 문제 해결 방법<a href="#clear의-동시성-문제-해결-방법" class="hash-link" aria-label="clear의-동시성-문제-해결-방법에 대한 직접 링크" title="clear의-동시성-문제-해결-방법에 대한 직접 링크" translate="no">​</a></h4>
<ul>
<li class="">
<p>각 트랜잭션이 독립적인 영속성 컨텍스트를 가지게 해 트랜잭션 간 격리성 향상</p>
</li>
<li class="">
<p>매 작업마다 DB에서 최신 데이터를 가져와 동시성 문제 해결</p>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="단점">단점<a href="#단점" class="hash-link" aria-label="단점에 대한 직접 링크" title="단점에 대한 직접 링크" translate="no">​</a></h4>
<ul>
<li class="">
<p>매번 DB에서 데이터를 가져와야 해 성능 이슈 발생 가능</p>
</li>
<li class="">
<p>상황에 따라 적절한 사용 필요 (하지만 영속성을 초기화 시킬 경우가 별로 없다고 함)</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="느낀점">느낀점<a href="#느낀점" class="hash-link" aria-label="느낀점에 대한 직접 링크" title="느낀점에 대한 직접 링크" translate="no">​</a></h2>
<ol>
<li class="">
<p>일단 작성한 코드를 기반으로 문제를 해결해서 매우 뿌듯하다.</p>
</li>
<li class="">
<p>다음에는 레디스의 특성을 이용한 동시성 제어를 사용해서 이러한 문제를 해결해봐야겠다.</p>
</li>
</ol></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>태그:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" title="학습기록" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/til">TIL</a></li><li class="tag_QGVx"><a rel="tag" title="데이터베이스" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/cs/database">Database</a></li><li class="tag_QGVx"><a rel="tag" title="HTTPS/TLS" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/cs/network/https">HTTPS</a></li><li class="tag_QGVx"><a rel="tag" title="Java 관련 글" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/dev/java">Java</a></li><li class="tag_QGVx"><a rel="tag" title="JWT 인증/인가" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/dev/auth/jwt">JWT</a></li><li class="tag_QGVx"><a rel="tag" title="네트워크" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/cs/network">Network</a></li><li class="tag_QGVx"><a rel="tag" title="Redis" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/cs/database/redis">Redis</a></li><li class="tag_QGVx"><a rel="tag" title="Spring/Spring Boot" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/dev/spring">Spring</a></li><li class="tag_QGVx"><a rel="tag" title="테스트/테스트코드" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/dev/testing">Testing</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="블로그 게시물 탐색"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/blog/infra/aws/4-배포-환경을-위한-단일-redis-인스턴스-aws-elasticcache-활용법"><div class="pagination-nav__sublabel">이전 게시물</div><div class="pagination-nav__label">4.배포 환경을 위한 단일 Redis 인스턴스: AWS ElasticCache 활용법</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/blog/til/2-redis를-사용한-동시성-제어"><div class="pagination-nav__sublabel">다음 게시물</div><div class="pagination-nav__label">2.Redis를 사용한 동시성 제어</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#개요" class="table-of-contents__link toc-highlight">개요</a></li><li><a href="#코드" class="table-of-contents__link toc-highlight">코드</a></li><li><a href="#테스트-코드" class="table-of-contents__link toc-highlight">테스트 코드</a></li><li><a href="#동시성-제어를-구현하다가-겪은-문제" class="table-of-contents__link toc-highlight">동시성 제어를 구현하다가 겪은 문제</a></li><li><a href="#해결-과정" class="table-of-contents__link toc-highlight">해결 과정</a></li><li><a href="#해결책" class="table-of-contents__link toc-highlight">해결책</a></li><li><a href="#해결된-테스트-결과" class="table-of-contents__link toc-highlight">해결된 테스트 결과</a></li><li><a href="#느낀점" class="table-of-contents__link toc-highlight">느낀점</a></li></ul></div></div></div></div></div></div>
</body>
</html>