"use strict";(globalThis.webpackChunkmy_portfolio=globalThis.webpackChunkmy_portfolio||[]).push([[27525],{27059:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var r=n(42203),s=n(74848),o=n(28453);const i={title:"\ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0\uc744 \uc704\ud55c \uc7ac\uace0 \uad00\ub9ac \uc804\ub7b5 \uc218\uc815",date:new Date("2024-10-16T00:00:00.000Z"),authors:["thunder"],tags:["til","https","java","network","spring","testing"]},a="\ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0\uc744 \uc704\ud55c \uc7ac\uace0 \uad00\ub9ac \uc804\ub7b5 \uc218\uc815",d={authorsImageUrls:[void 0]},l=[{value:"\ucf54\ub4dc \uc218\uc815",id:"\ucf54\ub4dc-\uc218\uc815",level:2},{value:"\ud14c\uc2a4\ud2b8 \ucf54\ub4dc",id:"\ud14c\uc2a4\ud2b8-\ucf54\ub4dc",level:2}];function c(e){const t={code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://github.com/pie0902/TIL/assets/47919911/31085744-c9a3-4196-b0a5-742c1f290005",alt:"\u1109\u1173\u110f\u1173\u1105\u1175\u11ab\u1109\u1163\u11ba 2024-04-08 \u110b\u1169\u110c\u1165\u11ab 9 54 54"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\uc704 \ucf54\ub4dc\ub85c \uc9c4\ud589\ud560 \uacbd\uc6b0 \ubb38\uc81c\uac00 \uc0dd\uae38 \uc0c1\ud669"}),"\n"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"\ub9cc\uc57d \uc5b4\ub5a4 \uc720\uc800\uac00 100\uac1c\uc758 \uc218\ub7c9\uc778 \uc0c1\ud488\uc744 100\uac1c \uc8fc\ubb38\ud558\uae30\ub97c \ub204\ub974\uace0 \uacb0\uc81c\ub97c \uc548\ud558\ub294 \uacbd\uc6b0"}),"\n",(0,s.jsx)(t.li,{children:"\ud55c \uc81c\ud488\uc5d0 \ub300\ud574 \uc5ec\ub7ec \uc8fc\ubb38\uc774 \ub3d9\uc2dc\uc5d0 \ub4e4\uc5b4\uc624\uace0, \uadf8 \uc911 \uba87\uba87\uc774 \uacb0\uc81c\ub418\uc9c0 \uc54a\uc73c\uba74, \uc2e4\uc81c\ub85c \uc5bc\ub9c8\ub098 \ub9ce\uc740 \uc7ac\uace0\uac00 \ub0a8\uc544 \uc788\ub294\uc9c0 \ucd94\uc801\ud558\uae30 \uc5b4\ub824\uc6cc\uc9d0."}),"\n"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\uac1c\uc120\ub41c \ucf54\ub4dc",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://github.com/pie0902/TIL/assets/47919911/17fa4b89-f6fc-4afd-aff9-f6da65791eb5",alt:"\u1109\u1173\u110f\u1173\u1105\u1175\u11ab\u1109\u1163\u11ba 2024-04-08 \u110b\u1169\u110c\u1165\u11ab 9 56 17"})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"\uacb0\uc81c\uac00 \uc644\ub8cc\ub41c \uc2dc\uc810\uc5d0 \uc0c1\ud488 \uc218\ub7c9\uc744 \uc5c5\ub370\uc774\ud2b8"}),"\n",(0,s.jsx)(t.li,{children:"\uacb0\uc81c \uc911\uc5d0 \ub204\uad70\uac00\uac00 \ub354 \ube60\ub974\uac8c \uc0c1\ud488\uc744 \uacb0\uc81c\ud558\uba74 \ucde8\uc18c\uac00 \ub420 \uc218\ub3c4 \uc788\uc74c"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"\ucf54\ub4dc-\uc218\uc815",children:"\ucf54\ub4dc \uc218\uc815"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'    @Transactional\n    public PayApproveResDto getApprove(String pgToken, Long orderId) throws Exception {\n        Order order = orderRepository.getReferenceById(orderId);\n        String tid = order.getKakaoTid();\n        HttpHeaders headers = new HttpHeaders();\n        String auth = "KakaoAK " + adminKey;\n        headers.set("Content-type", "application/x-www-form-urlencoded;charset=utf-8");\n        headers.set("Authorization", auth);\n        PayRequestDto payRequestDto = makeRequest.getApproveRequest(tid, pgToken);\n        HttpEntity<MultiValueMap<String, String>> requestEntity = new HttpEntity<>(payRequestDto.getMap(), headers);\n        RestTemplate rt = new RestTemplate();\n        PayApproveResDto payApproveResDto = rt.postForObject(payRequestDto.getUrl(), requestEntity,\n            PayApproveResDto.class);\n        //\ubc11\uc5d0\uc11c \uacb0\uc81c \uc644\ub8cc \ud6c4 \uc0c1\ud0dc \uc5c5\ub370\uc774\ud2b8\n        //\uc5ec\uae30\uc11c\n        System.out.println("\uce74\uce74\uc624 \uc11c\ube44\uc2a4 \uc2e4\ud589");\n        //\uc8fc\ubb38 \uc0c1\ud0dc\uac00 NOTPAY\uc778\uc9c0 \ud655\uc778\n        if (order.getState() != OrderState.NOTPAYED) {\n            throw new IllegalStateException("\uc8fc\ubb38 \uc0c1\ud0dc\uac00 \uacb0\uc81c \ub300\uae30 \uc0c1\ud0dc\uac00 \uc544\ub2d9\ub2c8\ub2e4.");\n        }\n        Map<Long, Long> basket = getBasketFromOrder(order);\n        entityManager.clear();\n        for (Long productId : basket.keySet()) {\n            String lockKey = "product_lock:" + productId;\n            RLock lock = redissonClient.getLock(lockKey);\n            try {\n                boolean isLocked = lock.tryLock(5, 10, TimeUnit.SECONDS);\n                if (!isLocked) {\n                    throw new RuntimeException("\ub77d \ud68d\ub4dd\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.");\n                }\n                orderService.updateStockAndCreateOrderDetail(productId, basket.get(productId));\n                order.changeState(OrderState.PREPARING);\n                orderRepository.save(order);\n\n            } catch (InterruptedException e) {\n                Thread.currentThread().interrupt(); // \uc2a4\ub808\ub4dc \uc778\ud130\ub7fd\ud2b8 \uc0c1\ud0dc \uc7ac\uc124\uc815\n                throw new RuntimeException("\ub77d \ud68d\ub4dd \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.", e);\n            } finally {\n                if (lock.isLocked()) {\n                    lock.unlock();\n                }\n            }\n        }\n        // \uc5ec\uae30\uae4c\uc9c0\n        return payApproveResDto;\n    }\n'})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"\uc544\uc9c1 \uacb0\uc81c\uac00 \uc548\ub41c \uc8fc\ubb38\uc11c\uc5d0 \ub300\ud574\uc11c\ub9cc \uacb0\uc81c\uac00 \uc9c4\ud589\ub418\ub3c4\ub85d \uc608\uc678 \ucc98\ub9ac\ub97c \ucd94\uac00"}),"\n",(0,s.jsx)(t.li,{children:"\uce74\uce74\uc624 \uacb0\uc81c\ubaa8\ub4c8 \uc11c\ube44\uc2a4\uc5d0\uc11c \uacb0\uc81c\uac00 \uc9c4\ud589 \ub41c \ud6c4\uc5d0 \uc218\ub7c9\uc744 \uccb4\ud06c\ud558\uace0 \uc8fc\ubb38\uc11c\uc758 \uc0c1\ud0dc\ub97c \ubcc0\uacbd\ud568"}),"\n",(0,s.jsx)(t.li,{children:"\uc218\ub7c9 \uc5c5\ub370\uc774\ud2b8 \ub85c\uc9c1\uc744 orderService\ub85c \ubd84\ub9ac \uc2dc\ucf1c\uc11c @Transactional\uc758 \ubc94\uc704\ub97c \uc870\uc815"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:" orderService.updateStockAndCreateOrderDetail(productId, basket.get(productId));\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\uc218\ub7c9 \uc5c5\ub370\uc774\ud2b8\uc640 \uc8fc\ubb38 \uc0c1\uc138 \uc815\ubcf4 \uc0dd\uc131 \ub85c\uc9c1\uc744 orderService\uc758 updateStockAndCreateOrderDetail \uba54\uc11c\ub4dc\ub85c \ubd84\ub9ac\ud568. \uc774 \uba54\uc11c\ub4dc\uc5d0\ub294 @Transactional \uc5b4\ub178\ud14c\uc774\uc158\uc774 \uc801\uc6a9\ub418\uc5b4 \uc788\uc73c\ubbc0\ub85c, \uba54\uc11c\ub4dc \ub0b4\ubd80\uc758 \ub370\uc774\ud130\ubca0\uc774\uc2a4 \uc791\uc5c5\uc740 \ud558\ub098\uc758 \ud2b8\ub79c\uc7ad\uc158\uc73c\ub85c \ucc98\ub9ac\uac00 \ub41c\ub2e4. \uc774\ub97c \ud1b5\ud574 \uc7ac\uace0 \uc5c5\ub370\uc774\ud2b8\uc640 \uc8fc\ubb38 \uc0c1\uc138 \uc815\ubcf4 \uc0dd\uc131\uc774 \uc6d0\uc790\uc801\uc73c\ub85c \uc774\ub8e8\uc5b4\uc9c0\ub3c4\ub85d \ud55c\ub2e4."}),"\n",(0,s.jsx)(t.li,{children:"getApprove \uba54\uc11c\ub4dc\uc5d0\uc11c\ub294 updateStockAndCreateOrderDetail \uba54\uc11c\ub4dc\ub97c \ud638\ucd9c\ud558\uc5ec \uacb0\uc81c \uc644\ub8cc \ud6c4 \ud544\uc694\ud55c \uc791\uc5c5\uc744 \ud55c\ub2e4. \uc774\ub54c getApprove \uba54\uc11c\ub4dc \uc790\uccb4\uc5d0\ub294 @Transactional \uc5b4\ub178\ud14c\uc774\uc158\uc774 \uc801\uc6a9\ub418\uc5b4 \uc788\uc73c\ubbc0\ub85c, updateStockAndCreateOrderDetail \uba54\uc11c\ub4dc\uc758 \ud2b8\ub79c\uc7ad\uc158\uc740 getApprove \uba54\uc11c\ub4dc\uc758 \ud2b8\ub79c\uc7ad\uc158\uc5d0 \ucc38\uc5ec\ud558\uac8c \ub41c\ub2e4."}),"\n",(0,s.jsx)(t.li,{children:"\ub9cc\uc57d updateStockAndCreateOrderDetail \uba54\uc11c\ub4dc\uc5d0\uc11c \uc608\uc678\uac00 \ubc1c\uc0dd\ud560 \uacbd\uc6b0, getApprove \uba54\uc11c\ub4dc\uc758 \ud2b8\ub79c\uc7ad\uc158\ub3c4 \ud568\uaed8 \ub864\ubc31\ub420 \uac83 \uc774\ub2e4. \uc774\ub97c \ud1b5\ud574 \uacb0\uc81c \uc2b9\uc778\uacfc \uad00\ub828\ub41c \ubaa8\ub4e0 \uc791\uc5c5\uc774 \uc77c\uad00\uc131 \uc788\uac8c \ucc98\ub9ac\ub418\ub3c4\ub85d \ud55c\ub2e4."}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"\ud14c\uc2a4\ud2b8-\ucf54\ub4dc",children:"\ud14c\uc2a4\ud2b8 \ucf54\ub4dc"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"\uc0c1\ud488 \uc218\ub7c9\uc744 1000\uac1c\ub85c \uc124\uc815\ud55c\ub2e4."}),"\n",(0,s.jsx)(t.li,{children:"100\uba85\uc758 \uc720\uc800\uac00 2\uac1c \uc529 \uc8fc\ubb38\ud558\ub294 \uc0c1\ud669\uc73c\ub85c \uc124\uc815\ud55c\ub2e4."}),"\n",(0,s.jsx)(t.li,{children:"\ud14c\uc2a4\ud2b8 \ud658\uacbd\uc774\ub77c KakaoPayService \ud074\ub798\uc2a4\uc758 getApprove \uba54\uc11c\ub4dc\uc758 \ubc18\ud658\ud0c0\uc785\uc744 void \ub85c \ub9e4\uac1c\ubcc0\uc218\ub97c orderId\ub9cc \ubc1b\uc544\uc624\ub294 \uac83\uc73c\ub85c \uc218\uc815\ud55c\ub2e4."}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'@SpringBootTest\n@TestPropertySource(locations = "classpath:test.properties")\nclass OrderServiceTest {\n\n    @MockBean\n    private ProductRepository productRepository;\n    @Autowired\n    private OrderService orderService;\n    UserDetailsImpl userDetails;\n    @Autowired\n    KakaoPayService kakaoPayService;\n    User user;\n    Product product;\n    Address address;\n    Map<Long, Long> basket = new HashMap<>();\n\n    @BeforeEach\n        //public void createOrder(Map<Long, Long> basket, UserDetailsImpl userDetails, Long addressId)\n    void set() {\n        user = new User(1L, "tester", "test@test.com", UserRoleEnum.USER);\n        userDetails = new UserDetailsImpl(user);\n        //product = new Product(1L,"test",1000L,"test",1000L,"photo",user.getId());\n        productRepository.save(product);\n        address = new Address(1L, "test", "test", "test", user.getId());\n        basket.put(1L, 2L);\n        Mockito.when(productRepository.findById(1L)).thenReturn(Optional.of(product));\n        // productRepository.getReferenceById\uac00 \ud638\ucd9c\ub420 \ub54c product \uac1d\uccb4\ub97c \ubc18\ud658\ud558\ub3c4\ub85d \uc124\uc815\n        Mockito.when(productRepository.getReferenceById(1L)).thenReturn(product);\n    }\n\n    @Test\n    @DisplayName("\ubcd1\ub82c\ub85c 100\ubc88 \uc2e4\ud589\ud558\uc5ec \uc7ac\uace0 \uc5c5\ub370\uc774\ud2b8 \ud14c\uc2a4\ud2b8")\n    void test() {\n        IntStream.range(0, 100).parallel().forEach(i -> {\n            try {\n                // createOrder \uba54\uc11c\ub4dc\ub85c\ubd80\ud130 Order\uc758 ID\ub97c \ubc1b\uc544\uc628\ub2e4.\n                //Long orderId = orderService.createOrder(basket, userDetails, address.getId());\n                // \ubc1b\uc544\uc628 orderId\ub97c kakaoPayService.getApprove \uba54\uc11c\ub4dc\uc5d0 \uc804\ub2ec\n                //kakaoPayService.getApprove(orderId); // \uc218\uc815\ub41c \ubd80\ubd84\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }\n        });\n    }\n}\n\n'})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.img,{src:"https://github.com/pie0902/TIL/assets/47919911/debdba13-5795-48f7-9f85-f90166ceb726",alt:"\u1109\u1173\u110f\u1173\u1105\u1175\u11ab\u1109\u1163\u11ba 2024-04-08 \u110b\u1169\u1112\u116e 3 06 38"}),"\n",(0,s.jsx)(t.img,{src:"https://github.com/pie0902/TIL/assets/47919911/1ea1f94d-502f-457b-b12a-caab44d7b80e",alt:"\u1109\u1173\u110f\u1173\u1105\u1175\u11ab\u1109\u1163\u11ba 2024-04-08 \u110b\u1169\u1112\u116e 3 07 11"})]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"\ub3d9\uc2dc\uc131\uc774 \uc798 \uc81c\uc5b4 \ub418\ub294 \uac83\uc744 \ud655\uc778\ud560 \uc218 \uc788\ub2e4."}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(96540);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}},42203:e=>{e.exports=JSON.parse('{"permalink":"/docs/blog/til/\ub3d9\uc2dc\uc131-\ubb38\uc81c-\ud574\uacb0\uc744-\uc704\ud55c-\uc7ac\uace0-\uad00\ub9ac-\uc804\ub7b5-\uc218\uc815","source":"@site/blog/til/\ub3d9\uc2dc\uc131-\ubb38\uc81c-\ud574\uacb0\uc744-\uc704\ud55c-\uc7ac\uace0-\uad00\ub9ac-\uc804\ub7b5-\uc218\uc815.md","title":"\ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0\uc744 \uc704\ud55c \uc7ac\uace0 \uad00\ub9ac \uc804\ub7b5 \uc218\uc815","description":"\u1109\u1173\u110f\u1173\u1105\u1175\u11ab\u1109\u1163\u11ba 2024-04-08 \u110b\u1169\u110c\u1165\u11ab 9 54 54","date":"2024-10-16T00:00:00.000Z","tags":[{"inline":false,"label":"TIL","permalink":"/docs/blog/tags/til","description":"\ud559\uc2b5\uae30\ub85d"},{"inline":false,"label":"HTTPS","permalink":"/docs/blog/tags/cs/network/https","description":"HTTPS/TLS"},{"inline":false,"label":"Java","permalink":"/docs/blog/tags/dev/java","description":"Java \uad00\ub828 \uae00"},{"inline":false,"label":"Network","permalink":"/docs/blog/tags/cs/network","description":"\ub124\ud2b8\uc6cc\ud06c"},{"inline":false,"label":"Spring","permalink":"/docs/blog/tags/dev/spring","description":"Spring/Spring Boot"},{"inline":false,"label":"Testing","permalink":"/docs/blog/tags/dev/testing","description":"\ud14c\uc2a4\ud2b8/\ud14c\uc2a4\ud2b8\ucf54\ub4dc"}],"readingTime":3.11,"hasTruncateMarker":false,"authors":[{"name":"thunder","title":"\uac1c\ubc1c\uc790","url":"https://github.com/pie0902","page":{"permalink":"/docs/blog/authors/thunder"},"socials":{"github":"https://github.com/pie0902"},"key":"thunder"}],"frontMatter":{"title":"\ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0\uc744 \uc704\ud55c \uc7ac\uace0 \uad00\ub9ac \uc804\ub7b5 \uc218\uc815","date":"2024-10-16T00:00:00.000Z","authors":["thunder"],"tags":["til","https","java","network","spring","testing"]},"unlisted":false,"prevItem":{"title":"Redis\ub97c \uc0ac\uc6a9\ud55c \ub3d9\uc2dc\uc131 \uc81c\uc5b4","permalink":"/docs/blog/til/redis\ub97c-\uc0ac\uc6a9\ud55c-\ub3d9\uc2dc\uc131-\uc81c\uc5b4"},"nextItem":{"title":"\ub3d9\uc2dc\uc131 \uc81c\uc5b4\uc5d0\uc11c \uacaa\uc740 \ubb38\uc81c \ud574\uacb0 \uacfc\uc815","permalink":"/docs/blog/til/\ub3d9\uc2dc\uc131-\uc81c\uc5b4\uc5d0\uc11c-\uacaa\uc740-\ubb38\uc81c-\ud574\uacb0-\uacfc\uc815"}}')}}]);